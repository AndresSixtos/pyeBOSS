#! /usr/bin/env python

import sys
from os.path import join
import os
import time
import numpy as np
import glob
import astropy.cosmology as co
cosmo = co.Planck13

# for one galaxy spectrum
import GalaxySpectrumFIREFLY as gs
import StellarPopulationModel as spm

catalog=gs.pyfits.open(join(os.environ['VVDS_DIR'], catalogs, "VVDS_DEEP_summary.fits"))[1].data

def runSpec(catalog_entry):
	# path to lite spectra
	#specLiteFile = join( os.environ['SDSSDR12_DIR'], str(plate), 'spec-'+str(plate)+ '-'+str(mjd)+'-' +str(fibre).zfill(4)+'.fits')
	# join( os.environ['BOSS_SPECTRO_REDUX'], os.environ['RUN2D'], 'spectra', 'lite' , str(plate), 'spec-'+str(plate)+ '-'+str(mjd)+'-' +str(fibre).zfill(4)+'.fits')
	outputFolder = join( os.environ['VVDS_DIR'], 'stellarpop-m11-salpeter')
	
	print( catalog_entry )
	t0=time.time()
	spec=gs.GalaxySpectrumFIREFLY("-", milky_way_reddening=True, survey='vvds')
	spec.openObservedVVDSpectrum(catalog_entry)
	ageMax = np.log10(cosmo.age(spec.redshift).value*1e9)
	if spec.redshift>0.01 and spec.redshift < 1.7 :
		model = spm.StellarPopulationModel(spec, join(outputFolder , os.path.basename(specLiteFile)[:-5] ), cosmo, models = 'm11', model_libs = ['MILES'], imfs = ['ss'], age_limits = [6,10], downgrade_models = True, data_wave_medium = 'vacuum', Z_limits = [-3.,1.],suffix="-SPM-MILES.fits", use_downgraded_models = True)
		try :
			model.fit_models_to_data()
			#model = spm.StellarPopulationModel(spec, join( outputFolder , specLiteFile.split('/')[-1][:-5]), cosmo, models = 'm11', model_libs = ['STELIB'], imfs = ['ss'], age_limits = [6,10], downgrade_models = True, data_wave_medium = 'vacuum', Z_limits = [-3.,1.],suffix="-SPM-STELIB.fits", use_downgraded_models = True)
			#model.fit_models_to_data()
			#print( model.averages )
		except (ValueError):
			pass

	print "time used =", time.time()-t0 ,"seconds"
	return spec

spec = runSpec(catalog[0])