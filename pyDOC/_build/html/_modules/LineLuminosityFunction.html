<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>LineLuminosityFunction &mdash; pySU, python Skies and Universes 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pySU, python Skies and Universes 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>pySU, python Skies and Universes 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>LineLuminosityFunction</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for LineLuminosityFunction</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. class:: LineLuminosityFunction</span>
<span class="sd">.. class:: ModelLuminosityFunction</span>

<span class="sd">.. moduleauthor:: Johan Comparat &lt;johan.comparat__at__gmail.com&gt;</span>

<span class="sd">The class LineLuminosityFunction is dedicated to measuring the line luminosity functions. The class ModelLuminosityFunction is dedicated to fitting models to the LFs.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span> 
<span class="kn">import</span> <span class="nn">astropy.cosmology</span> <span class="kn">as</span> <span class="nn">co</span>
<span class="n">cosmo</span><span class="o">=</span><span class="n">co</span><span class="o">.</span><span class="n">FlatLambdaCDM</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span><span class="n">Om0</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="kn">as</span> <span class="nn">fits</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">n</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

<div class="viewcode-block" id="ModelLuminosityFunction"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.ModelLuminosityFunction">[docs]</a><span class="k">class</span> <span class="nc">ModelLuminosityFunction</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The model luminosity function class</span>
<span class="sd">	:param lineWavelength: restframe wavelength in the air</span>
<span class="sd">	:param lineName: name of the line used in the catalogs.</span>
<span class="sd">	:param cosmology: cosmology used (astropy class) Default H0=70,Omega matter=0.3</span>
<span class="sd">	:param LF_file_list: list of LF_files. Each entry is a list of 2 files, the fits file (data used to derivee the LF) and the txt file (LF).</span>
<span class="sd">	:param model: Model to be fitted : Saunders, Saunders3P, or Schechter, DoublePL</span>
<span class="sd">	:param p0: Initial guess of the parameters</span>
<span class="sd">	:param outputDirectory: where to output the fits</span>
<span class="sd">	:param fileName: file name where things are saved.</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineWavelength</span><span class="o">=</span><span class="mf">3727.4228417998916</span><span class="p">,</span> <span class="n">lineName</span><span class="o">=</span><span class="s">&quot;O2_3728&quot;</span><span class="p">,</span> <span class="n">cosmology</span> <span class="o">=</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">LF_file_list</span><span class="o">=</span><span class="p">[],</span> <span class="n">model</span><span class="o">=</span><span class="s">&#39;Saunders&#39;</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">],</span> <span class="n">outputDirectory</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">fixedSigma</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">fixedAlpha</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lineWavelength</span> <span class="o">=</span> <span class="n">lineWavelength</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lineName</span> <span class="o">=</span> <span class="n">lineName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span> <span class="o">=</span> <span class="n">cosmology</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database_dir</span> <span class="o">=</span> <span class="s">&quot;/home/comparat/database/&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">biblioPts_dir</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">database_dir</span> <span class="o">+</span><span class="s">&quot;Products_Galaxies/emissionLineLuminosityFunctions/bibliographyPoints/&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fixedSigma</span> <span class="o">=</span> <span class="n">fixedSigma</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fixedAlpha</span> <span class="o">=</span> <span class="n">fixedAlpha</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">LF_file_list</span> <span class="o">=</span> <span class="n">LF_file_list</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">schecterFct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logl</span><span class="p">,</span><span class="n">logls</span><span class="p">,</span><span class="n">ps</span><span class="p">,</span><span class="n">a</span> <span class="p">:</span> <span class="n">ps</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">logl</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="n">logls</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="o">**</span><span class="n">logl</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="n">logls</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">saundersFct</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logl</span><span class="p">,</span><span class="n">logls</span><span class="p">,</span><span class="n">ps</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">sig</span> <span class="p">:</span> <span class="n">ps</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">logl</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="n">logls</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span> <span class="o">-</span><span class="n">n</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="mi">1</span> <span class="o">+</span><span class="mi">10</span><span class="o">**</span><span class="n">logl</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="n">logls</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sig</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">saundersFct3P</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logl</span><span class="p">,</span><span class="n">logls</span><span class="p">,</span><span class="n">ps</span><span class="p">,</span><span class="n">a</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">saundersFct</span><span class="p">(</span><span class="n">logl</span><span class="p">,</span> <span class="n">logls</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedSigma</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">saundersFct2P</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logl</span><span class="p">,</span><span class="n">logls</span><span class="p">,</span><span class="n">ps</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">saundersFct</span><span class="p">(</span><span class="n">logl</span><span class="p">,</span> <span class="n">logls</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedAlpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixedSigma</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">doublePL</span><span class="o">=</span><span class="k">lambda</span> <span class="n">logl</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">logls</span> <span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">logl</span> <span class="o">-</span> <span class="n">logls</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="p">)</span>
		<span class="n">modelDict</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Saunders2P&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">saundersFct2P</span><span class="p">,</span> <span class="s">&#39;Saunders3P&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">saundersFct3P</span><span class="p">,</span> <span class="s">&#39;Saunders&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">saundersFct</span><span class="p">,</span> <span class="s">&#39;Schechter&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schecterFct</span><span class="p">,</span> <span class="s">&#39;DoublePL&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublePL</span> <span class="p">}</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">model_to_fit</span> <span class="o">=</span> <span class="n">modelDict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">p0</span> <span class="o">=</span> <span class="n">p0</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">outputDirectory</span> <span class="o">=</span> <span class="n">outputDirectory</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>

<div class="viewcode-block" id="ModelLuminosityFunction.fitModel"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.ModelLuminosityFunction.fitModel">[docs]</a>	<span class="k">def</span> <span class="nf">fitModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">bibliographyPts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		fits the chosen model to the list of Measured LFs</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">ye</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="p">[],[],[],[]</span>
		<span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LF_file_list</span><span class="p">:</span>
			<span class="n">lf_fits_file</span><span class="p">,</span><span class="n">lf_measurement_file</span> <span class="o">=</span> <span class="n">el</span>

			<span class="n">hduG</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lf_fits_file</span><span class="p">)</span>
			<span class="n">hdu</span><span class="o">=</span><span class="n">hduG</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
			<span class="n">catalog</span><span class="o">=</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span>
			<span class="n">completeness</span><span class="o">=</span><span class="n">hduG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;COMPLETENESS&#39;</span><span class="p">]</span>
			<span class="n">volume</span><span class="o">=</span><span class="n">hduG</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;VOLUME&#39;</span><span class="p">]</span>
			<span class="n">Lmin</span><span class="p">,</span> <span class="n">Lmax</span><span class="p">,</span> <span class="n">Lmean</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">phiErr</span><span class="p">,</span> <span class="n">phiErr_poisson</span><span class="p">,</span> <span class="n">ngals</span><span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span> <span class="n">lf_measurement_file</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
			<span class="n">selected</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">LmeanEl</span> <span class="o">&gt;</span> <span class="n">completeness</span> <span class="k">for</span> <span class="n">LmeanEl</span> <span class="ow">in</span> <span class="n">Lmean</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;</span> <span class="mf">5.</span> <span class="o">/</span> <span class="n">volume</span><span class="p">)</span>
			<span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Lmean</span><span class="p">[</span><span class="n">selected</span><span class="p">])</span>
			<span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">selected</span><span class="p">])</span>
			<span class="n">ye</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phiErr</span><span class="p">[</span><span class="n">selected</span><span class="p">])</span>
			<span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lf_measurement_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">print</span> <span class="n">lf_fits_file</span><span class="p">,</span> <span class="n">completeness</span><span class="p">,</span> <span class="n">Lmean</span><span class="p">[</span><span class="n">selected</span><span class="p">],</span> <span class="n">phi</span><span class="p">[</span><span class="n">selected</span><span class="p">]</span>

		<span class="k">if</span> <span class="n">bibliographyPts</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">:</span>
			<span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bibliographyPts</span><span class="p">)):</span>
				<span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bibliographyPts</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
				<span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bibliographyPts</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
				<span class="n">ye</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bibliographyPts</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
				<span class="n">name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bibliographyPts</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
			
		<span class="n">xFi</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">x</span><span class="p">))</span>
		<span class="n">yFi</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">y</span><span class="p">))</span>
		<span class="n">yeFi</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">ye</span><span class="p">))</span>

		<span class="n">ok</span><span class="o">=</span><span class="p">(</span><span class="n">xFi</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">yFi</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">yeFi</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
		<span class="c"># print xFi,yFi,yeFi</span>

		<span class="n">xF</span><span class="o">=</span><span class="n">xFi</span><span class="p">[</span><span class="n">ok</span><span class="p">][</span><span class="n">n</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">xFi</span><span class="p">[</span><span class="n">ok</span><span class="p">])]</span>
		<span class="n">yF</span><span class="o">=</span><span class="n">yFi</span><span class="p">[</span><span class="n">ok</span><span class="p">][</span><span class="n">n</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">xFi</span><span class="p">[</span><span class="n">ok</span><span class="p">])]</span>
		<span class="n">yeF</span><span class="o">=</span><span class="n">yeFi</span><span class="p">[</span><span class="n">ok</span><span class="p">][</span><span class="n">n</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">xFi</span><span class="p">[</span><span class="n">ok</span><span class="p">])]</span>
		<span class="k">print</span> <span class="s">&quot;final array&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xF</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">yF</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">yeF</span><span class="p">)</span>
		<span class="k">print</span> <span class="n">xF</span><span class="p">,</span> <span class="n">yF</span><span class="p">,</span> <span class="n">yeF</span>
		<span class="n">popt</span><span class="p">,</span><span class="n">popc</span><span class="o">=</span><span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_to_fit</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xF</span><span class="p">),</span><span class="n">yF</span><span class="p">,</span><span class="n">p0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p0</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">yeF</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">5000000</span><span class="p">)</span>
		<span class="k">print</span> <span class="s">&quot;result&quot;</span><span class="p">,</span> <span class="n">popt</span><span class="p">,</span> <span class="n">popc</span>
		<span class="c">#yMod=self.model_to_fit(xF,popt)</span>
		<span class="n">n</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputDirectory</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="o">+</span><span class="s">&quot;.points&quot;</span><span class="p">,</span><span class="n">n</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="n">xF</span><span class="p">,</span><span class="n">yF</span><span class="p">,</span><span class="n">yeF</span><span class="p">]))</span>
		<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputDirectory</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="o">+</span><span class="s">&quot;.fitInfo&quot;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
		<span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">LF_file_list</span> <span class="p">:</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">el</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">popt</span><span class="p">))</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">popc</span><span class="p">))</span>
		<span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39; </span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">return</span> <span class="n">popt</span><span class="p">,</span><span class="n">popc</span><span class="p">,</span><span class="n">xF</span><span class="p">,</span><span class="n">yF</span><span class="p">,</span><span class="n">yeF</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">ye</span><span class="p">,</span> <span class="n">name</span>


</div></div>
<div class="viewcode-block" id="LineLuminosityFunction"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction">[docs]</a><span class="k">class</span> <span class="nc">LineLuminosityFunction</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	The line luminosity function class</span>
<span class="sd">	:param lineWavelength: restframe wavelength in the air</span>
<span class="sd">	:param lineName: name of the line used in the catalogs.</span>
<span class="sd">	:param cosmology: cosmology used (astropy class) Default H0=70,Omega matter=0.3</span>
<span class="sd">    :param surveyName: Name of the survey used (needs to be the one given in the database)</span>
<span class="sd">    :param redshift_catalog: name of the redshift catalog </span>
<span class="sd">	:param SNlimit: signal to noise ratio limit. For a line measurement to be included SN of the line must be greater than SNlimit.</span>
<span class="sd">	:param luminosityBins: bins in luminosity equally spaced in log space.</span>
<span class="sd">	:param Nstack: number of spectra per stack</span>
<span class="sd">	:param Nclustering:	number of spectra per clustering sample from the brightest to the faintest</span>
<span class="sd">	:param outputFolder: folder where the results will be written</span>
<span class="sd">	:param zmin: minimum redshift included</span>
<span class="sd">	:param zmax: maximum redshift included</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineWavelength</span><span class="o">=</span><span class="mf">3727.4228417998916</span><span class="p">,</span> <span class="n">lineName</span><span class="o">=</span><span class="s">&quot;O2_3728&quot;</span><span class="p">,</span> <span class="n">cosmology</span> <span class="o">=</span> <span class="n">cosmo</span><span class="p">,</span> <span class="n">surveyName</span> <span class="o">=</span>  <span class="s">&quot;DEEP2&quot;</span><span class="p">,</span> <span class="n">redshift_catalog</span> <span class="o">=</span> <span class="s">&quot;zcat.deep2.dr4.v2.LFcatalog.fits&quot;</span><span class="p">,</span> <span class="n">SNlimit</span> <span class="o">=</span> <span class="mf">5.</span><span class="p">,</span> <span class="n">luminosityBins</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="mi">45</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> <span class="n">Nstack</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">Nclustering</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">outputFolder</span><span class="o">=</span><span class="s">&quot;emissionLineLuminosityFunctions/&quot;</span> <span class="p">,</span> <span class="n">zmin</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lineWavelength</span> <span class="o">=</span> <span class="n">lineWavelength</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">lineName</span> <span class="o">=</span> <span class="n">lineName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cosmology</span> <span class="o">=</span> <span class="n">cosmology</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">surveyName</span> <span class="o">=</span> <span class="n">surveyName</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">redshift_catalog</span> <span class="o">=</span> <span class="n">redshift_catalog</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">database_dir</span> <span class="o">=</span> <span class="s">&quot;/home/comparat/database/&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">database_dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">surveyName</span><span class="o">+</span><span class="s">&quot;/&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">catalog_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span><span class="o">+</span><span class="s">&quot;catalogs/&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">survey_dir</span><span class="o">+</span><span class="s">&quot;products/&quot;</span><span class="o">+</span><span class="n">outputFolder</span><span class="o">+</span><span class="n">lineName</span><span class="o">+</span><span class="s">&quot;/&quot;</span>
		<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;mkdir &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="p">)</span>
		<span class="n">hd</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog_dir</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift_catalog</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">catalog</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
		<span class="n">hd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Ngalaxies</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">SNlimit</span> <span class="o">=</span>  <span class="n">SNlimit</span> <span class="c"># 5.</span>
		<span class="c">#self.nbins = 15#n.arange(38.5,45,0.25)#15</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span> <span class="o">=</span> <span class="n">luminosityBins</span> <span class="c">#15</span>
		<span class="c">#self.nbinsUD = 4</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Nstack</span> <span class="o">=</span> <span class="n">Nstack</span> <span class="c"># number of spectra per stack</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">Nclustering</span> <span class="o">=</span> <span class="n">Nclustering</span> <span class="c"># number of spectra per clustering sample from the brightest to the </span>

		<span class="bp">self</span><span class="o">.</span><span class="n">zmin</span> <span class="o">=</span> <span class="n">zmin</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">=</span> <span class="n">zmax</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_luminosity&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">luminosityErr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_luminosityErr&#39;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">volume_per_sq_degree</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z1</span><span class="p">,</span><span class="n">z2</span> <span class="p">:</span> <span class="p">(</span><span class="n">cosmo</span><span class="o">.</span><span class="n">comoving_volume</span><span class="p">(</span> <span class="n">z2</span> <span class="p">)</span> <span class="o">-</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">comoving_volume</span><span class="p">(</span> <span class="n">z1</span> <span class="p">))</span> <span class="o">*</span><span class="n">n</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">129600.</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">lineSelection</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_flux&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_fluxErr&#39;</span><span class="p">]</span> <span class="o">&gt;</span><span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_flux&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">SNlimit</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_fluxErr&#39;</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_luminosity&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_luminosity&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1e50</span><span class="p">)</span>

<div class="viewcode-block" id="LineLuminosityFunction.setRedshiftArray"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.setRedshiftArray">[docs]</a>	<span class="k">def</span> <span class="nf">setRedshiftArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">redshiftColumn</span><span class="o">=</span><span class="s">&#39;ZBEST&#39;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; sets the redshift array</span>
<span class="sd">		:param redshiftColumn: column of the catalog corresponding to the redshift.</span>
<span class="sd">		Stores it in self.redshift.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">redshiftColumn</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="LineLuminosityFunction.setWeightArray"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.setWeightArray">[docs]</a>	<span class="k">def</span> <span class="nf">setWeightArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">weightColumn</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; sets the weight column </span>
<span class="sd">		:param weightColumn: statistical weight per galaxy 1 / (area * TSR * SSR)</span>
<span class="sd">		Divides the weight by the volume of the bin stores it in self.weight.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">volume_per_sq_degree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="p">)</span> <span class="o">*</span> <span class="n">area</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">weight</span> <span class="o">=</span> <span class="n">weightColumn</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_per_sq_degree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zmin</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LineLuminosityFunction.setRedshiftSelection"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.setRedshiftSelection">[docs]</a>	<span class="k">def</span> <span class="nf">setRedshiftSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redshiftQualityColumn</span><span class="o">=</span><span class="s">&#39;ZQUALITY&#39;</span><span class="p">,</span> <span class="n">upperBound</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">lowerBound</span><span class="o">=</span><span class="mf">7.</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; sets the redshift selection</span>
<span class="sd">		:param redshiftQualityColumn: column of the catalog corresponding to the  quality of the redshifts.</span>
<span class="sd">		:param lowerBound : lower bound to redshift quality :  zquality &gt; lowerBound</span>
<span class="sd">		:param upperBound : upper bound to the redshift quality : zquality &lt; upperBound</span>
<span class="sd">		Stores it in self.redshiftSelection.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">redshiftSelection</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">zmin</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">redshiftQualityColumn</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">lowerBound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">redshiftQualityColumn</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">upperBound</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LineLuminosityFunction.computeMeanWeightedRedshift"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.computeMeanWeightedRedshift">[docs]</a>	<span class="k">def</span> <span class="nf">computeMeanWeightedRedshift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sel</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Computes the weighted mean redshift of the sample.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineSelection</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshiftSelection</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">meanRedshift</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshift</span><span class="p">[</span><span class="n">selection</span><span class="p">],</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">selection</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="LineLuminosityFunction.computeHistogramLF"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.computeHistogramLF">[docs]</a>	<span class="k">def</span> <span class="nf">computeHistogramLF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sel</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Computes the weighted and unweighted histogram to get the number density and Poisson errors.</span>
<span class="sd">		:param sel: array selecting the galaxies of interest in the catalog (Boolean). </span>
<span class="sd">		Returns Weighted density, Error on the weighted density, Number of galaxies used in eacah bin, the luminosity bins.</span>
<span class="sd">		It stores the values in self.LF, self.LFerr_poisson, self.ngals. It also evaluates the mean luminosity in each luminosity bin self.xL and dlogL to obtain the LF</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineSelection</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshiftSelection</span><span class="p">)</span>
		<span class="n">N10p</span><span class="p">,</span><span class="n">bin1p</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span><span class="p">[</span><span class="n">selection</span><span class="p">],</span><span class="n">bins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">)</span>
		<span class="n">N10</span><span class="p">,</span><span class="n">bin1</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span><span class="p">[</span><span class="n">selection</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span> <span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">LF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">LFerr_poisson</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngals</span> <span class="o">=</span> <span class="n">N10</span><span class="p">,</span> <span class="n">N10</span><span class="o">*</span><span class="n">N10p</span><span class="o">**</span><span class="mf">0.5</span><span class="o">/</span><span class="n">N10p</span><span class="p">,</span> <span class="n">N10p</span>

		<span class="n">xSelections</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="o">&amp;</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span><span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span> <span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">])</span>

		<span class="n">xLi</span><span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xSelections</span><span class="p">))</span> <span class="p">:</span>
			<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span><span class="p">[</span><span class="n">xSelections</span><span class="p">[</span><span class="n">jj</span><span class="p">]])</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
				<span class="n">xLi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">n</span><span class="o">.</span><span class="n">average</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span><span class="p">[</span><span class="n">xSelections</span><span class="p">[</span><span class="n">jj</span><span class="p">]],</span> <span class="n">weights</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">xSelections</span><span class="p">[</span><span class="n">jj</span><span class="p">]]</span> <span class="p">)</span> <span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">xLi</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span> <span class="p">)</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">xL</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xLi</span><span class="p">)</span>
		<span class="n">dLogL_all</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">dLogL</span> <span class="o">=</span> <span class="n">dLogL_all</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="LineLuminosityFunction.computeHistogramVariance"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.computeHistogramVariance">[docs]</a>	<span class="k">def</span> <span class="nf">computeHistogramVariance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sel</span><span class="p">,</span><span class="n">jk</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; Computes the variance of the histogram using N subsamples.</span>
<span class="sd">		:param sel: array selecting the galaxies of interest in the catalog (Boolean). </span>
<span class="sd">		:param jk: percentage of the data set removed in each realization.</span>
<span class="sd">		Stores the values in self.LFerr_jackknife</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineSelection</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshiftSelection</span><span class="p">)</span>
		<span class="c">#N10p,bin1p=n.histogram(self.luminosity[selection],bins=self.luminosityBins)</span>
		<span class="n">L_jk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosity</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
		<span class="n">w_jk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
		<span class="n">rdArr</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">L_jk</span><span class="p">))</span>
		<span class="n">values</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="mf">0.9</span><span class="o">*</span><span class="n">jk</span><span class="p">,</span><span class="n">jk</span><span class="p">)</span>
		<span class="n">randSelNot</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">rdArr</span><span class="o">&gt;</span><span class="n">values</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rdArr</span><span class="o">&lt;</span><span class="n">values</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
		<span class="n">randSel</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">el</span><span class="o">==</span><span class="bp">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">randSelNot</span><span class="p">])</span>
		<span class="n">lumJK</span><span class="o">=</span><span class="p">[]</span>
		<span class="k">for</span> <span class="n">selR</span> <span class="ow">in</span> <span class="n">randSel</span> <span class="p">:</span>
			<span class="n">N10</span><span class="p">,</span><span class="n">bin1</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">L_jk</span><span class="p">[</span><span class="n">selR</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span> <span class="n">w_jk</span><span class="p">[</span><span class="n">selR</span><span class="p">]</span> <span class="p">)</span>
			<span class="n">lumJK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N10</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">LFerr_jackknife</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lumJK</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LineLuminosityFunction.get_completness_limit"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.get_completness_limit">[docs]</a>	<span class="k">def</span> <span class="nf">get_completness_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sel</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Estimates the completeness. It maps the maximum of the EW distribution to a Luminosity limit.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineSelection</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshiftSelection</span><span class="p">)</span>
		<span class="n">bins</span><span class="o">=</span><span class="n">n</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
		<span class="n">aa</span><span class="p">,</span><span class="n">bb</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_EW&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">completness_limit_EW</span> <span class="o">=</span> <span class="n">bb</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
		
		<span class="n">EWselection</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_EW&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span> <span class="o">&gt;</span><span class="mf">0.9</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">completness_limit_EW</span> <span class="p">)</span><span class="o">&amp;</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_EW&#39;</span><span class="p">][</span><span class="n">selection</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.1</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">completness_limit_EW</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">completness_limit_luminosity</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">median</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineName</span><span class="o">+</span><span class="s">&#39;_luminosity&#39;</span><span class="p">][</span> <span class="n">selection</span> <span class="p">][</span> <span class="n">EWselection</span> <span class="p">])</span>

		<span class="c"># bins=n.logspace(39.5,43,20)</span>
		<span class="c"># aa,bb = n.histogram(self.catalog[self.lineName+&#39;_luminosity&#39;][selection], bins=bins)</span>
		<span class="c">#self.completness_limit_luminosity = bb[n.argmax(aa)+1]</span>
	</div>
<div class="viewcode-block" id="LineLuminosityFunction.correctVolumeEffect"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.correctVolumeEffect">[docs]</a>	<span class="k">def</span> <span class="nf">correctVolumeEffect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mCorr</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; corrects from the volume effect on the measurement and the error estimation</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LF</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dLogL</span> <span class="o">*</span> <span class="n">mCorr</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">phiErr</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">LFerr_jackknife</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dLogL</span> <span class="o">*</span> <span class="n">mCorr</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">*</span> <span class="n">error</span> <span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">phiErr_poisson</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LFerr_poisson</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dLogL</span> <span class="o">*</span> <span class="n">mCorr</span>
</div>
<div class="viewcode-block" id="LineLuminosityFunction.writeLF"><a class="viewcode-back" href="../LineLuminosityFunction.html#LineLuminosityFunction.LineLuminosityFunction.writeLF">[docs]</a>	<span class="k">def</span> <span class="nf">writeLF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sel</span><span class="p">,</span><span class="n">surveyNameSuffix</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot; writes the measured LF and the data used to derive it to an ascii and a fits file.</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineName</span> <span class="o">+</span> <span class="s">&quot;-&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyName</span><span class="o">+</span><span class="n">surveyNameSuffix</span> <span class="o">+</span> <span class="s">&quot;-z&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">n</span><span class="o">.</span><span class="n">round</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanRedshift</span> <span class="p">,</span><span class="mi">3</span> <span class="p">))</span> 

		<span class="n">selection</span> <span class="o">=</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lineSelection</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redshiftSelection</span><span class="p">)</span>
		<span class="n">new_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">columns</span>

		<span class="n">tbhdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">BinTableHDU</span><span class="o">.</span><span class="n">from_columns</span><span class="p">(</span><span class="n">new_columns</span><span class="p">)</span>
		<span class="n">tbhdu</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tbhdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
		<span class="n">prihdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
		<span class="n">prihdr</span><span class="p">[</span><span class="s">&#39;COMPLETENESS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">completness_limit_luminosity</span>
		<span class="k">print</span> <span class="s">&quot;volume&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">value</span>
		<span class="n">prihdr</span><span class="p">[</span><span class="s">&#39;VOLUME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">value</span>
		<span class="n">prihdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="n">prihdr</span><span class="p">)</span>
		<span class="n">thdulist</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">prihdu</span><span class="p">,</span> <span class="n">tbhdu</span><span class="p">])</span>

		<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&#39;rm -rf &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.fits&quot;</span><span class="p">)</span>
		<span class="n">thdulist</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.fits&quot;</span><span class="p">)</span>                        

		<span class="n">head</span><span class="o">=</span> <span class="s">&quot; Lmin Lmax Lmean phi phiErr phiErr_poisson Ngalaxy&quot;</span>
		<span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">+</span> <span class="n">filename</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
		<span class="n">n</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">luminosityBins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">xL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phiErr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">phiErr_poisson</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ngals</span><span class="p">])</span> <span class="p">,</span><span class="n">header</span><span class="o">=</span> <span class="n">head</span><span class="p">)</span>
		<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div></div></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, johan comparat.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>